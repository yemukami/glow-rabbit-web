# Glow-Rabbit Web - Pacing Spec (Field Notes)

## 背景
- LED制御は「400mごとにペース命令を再送」する設計。区間ごとに理想ペースを再設定し、端数や実機ズレを吸収するため。
- コマンドは 0.1 秒刻みで丸めて送信。BLE/GATT上の負荷と実走の解像度のバランス。

## 入力と丸め
- シンプル設定: ゴール目標タイムを mm:ss.d 形式で入力。内部では秒に変換し、runPlan生成時に 0.1 秒刻みで丸め。
- 区間設定: 区間ペースは「秒」で入力してもらう前提（整数秒推奨）。小数が入っても最終的に 0.1 秒刻みに丸めて送信。
- 表示: UIは 0.1 秒精度で表示を統一（入力中も平均ペースや予想ゴールタイムは0.1秒単位）。

## 400mチャンク化の理由
1) 端数の累積を抑制  
   - 各チャンクで丸め誤差を「carry」で次チャンクに渡し、最後のチャンクだけが残差を受ける。誤差はチャンクあたり ±0.05s、累積しても中距離で ±0.2〜0.6s 程度。
2) ペース切替の位相ズレを吸収  
   - ビルドアップ/ダウンや補正を400m境界で確実に適用し直せる。
3) 実機同期の堅牢性  
   - 2m間隔デバイスとの微妙な遅れ・揺らぎを周回ごとにリセットできる。

## 200m指示を400m送信に均す際のズレ
- 400m単位でしか送れないため、200mで変えたい指示は「半周遅れ」で適用される。
- ズレの目安: ペース差(秒/400m) × 0.5 が遅れ時間のおおよその上限。現実的な差 0.5〜2.0s/400m なら位相ズレは 0.25〜1.0s 程度。
- 丸め誤差（±0.05s/チャンク）より、位相ズレが支配的。ゴールタイム全体では概ね 1s 未満〜1s 程度に収まる想定。

## 最終チャンクでの誤差
- 最終400mには「次の400m」がないため、carryの行き先がなくても誤差は ±0.05s 内が上限。厳密一致が必要なら最終チャンクで誤差吸収する拡張は可能だが、現状は0.1s丸めのまま運用。

## 実運用のガイド
- 入力精度: シンプル/区間とも 0.1s 表示に揃え、区間は整数秒を推奨（誤差は400mごとの再送でほぼ吸収）。
- シナリオ: 中距離の常識的なペース変化（1〜2秒/400mのビルドアップ/ダウン）では、実走とLEDのズレはおおむね 1 秒以内に収まる。
- より厳密なゴール一致が必要な場合は、最終チャンクで carry を吸収する方式に切り替える余地あり。
