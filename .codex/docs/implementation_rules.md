# Implementation Rules to Avoid Large Refactors (Glow-Rabbit Web App)

作業開始前に一読し、変更が「できない/やらない」範囲も明示すること。

1. ユースケース単位の完成定義＋テスト先行  
   START/同期/STOPなど外部仕様を、入力・状態遷移・副作用（BLE送信）まで含めてユースケースごとに定義し、そのままテスト（ユニット＋E2E手順）に落とす。仕様が動かせない箇所ほど先にテスト化。
2. 境界の早期分離（UI→サービス→BLE）  
   UIは描画とイベント発火のみ、サービスは状態遷移とコマンド決定、BLEは送信のみ。境界を守るアダプタを先に置き、後の変更量を減らす。
3. プロトコル制約を明文化し、不可な要件をUIで近似しない  
   例: stopRunnerは全体停止のみ。ペーサー個別STOPはFW/プロトコル拡張が必要と明記し、UI側だけで擬似実装しない。
4. 変更前後の「入場テスト」を固定  
   最低限回すチェックリスト（node --check＋該当テスト＋E2E基本セット）を固定し、すべての変更で実行する。
5. 観測ログを先に用意  
   送信サマリや状態フラグの可視化を早期に入れ、挙動確認をログ前提で行う。
6. 暫定対応はフラグ化し、切り戻し条件を決める  
   先行点灯やFINISH_MARGIN変更などはフラグ化し、切り戻し条件と期限を明示する。
7. 後戻りが大きい点を先にレビュー・合意  
   START/同期責務やペーサー停止方法など、後から変えにくい箇所は着手前にレビューして固定する。
8. ドキュメントとコードを一貫更新  
   仕様/ルール/ログをセットで更新し、後追いの補記を減らす。
