<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glow-Rabbit for Race v15</title>
    <link rel="icon" href="image_c2633c.png" type="image/png">
    
    <style>
        :root {
            /* Glow Rabbit Orange Theme */
            --primary-color: #F38B00;
            --primary-hover: #D97B00;
            
            --danger-color: #FF4D4D;
            --success-color: #4CD964;
            --secondary-color: #5856D6;
            --info-color: #007AFF;
            
            /* UI Colors */
            --bg-color: #F0F4F8;
            --card-bg: #FFFFFF;
            --border-color: #E1E5EA;
            --text-main: #333333;
            --text-sub: #8E8E93;
            --header-bg: #FFFFFF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main);
        }

        /* HEADER */
        header {
            background-color: var(--header-bg);
            color: var(--text-main);
            padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 64px; flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            z-index: 100;
        }
        .header-left {
            display: flex; align-items: center; gap: 12px;
        }
        .logo-mark {
            height: 40px; width: auto; display: block;
        }
        .system-title {
            font-size: 20px; font-weight: 800; color: var(--primary-color);
            letter-spacing: -0.5px;
        }
        
        .header-right {
            display: flex; align-items: center; gap: 20px;
        }
        .ble-status {
            font-size: 12px; color: #999; display:flex; align-items:center; gap:5px; font-weight:bold;
        }

        /* MODE SWITCH */
        .mode-switch {
            background: #F2F2F7; border-radius: 12px; padding: 4px; display: flex;
        }
        .mode-btn {
            padding: 8px 16px; border-radius: 10px; border: none;
            background: transparent; color: #8E8E93; font-weight: bold; cursor: pointer;
            transition: all 0.2s; font-size: 13px;
        }
        .mode-btn.active {
            background: var(--card-bg); color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* MAIN */
        main { flex: 1; padding: 20px; overflow-y: auto; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UTILS & COLORS */
        .bg-red { background: #FF4D4D; } .text-red { color: #FF4D4D; }
        .bg-blue { background: #007AFF; } .text-blue { color: #007AFF; }
        .bg-green { background: #4CD964; } .text-green { color: #4CD964; }
        .bg-yellow { background: #FFCC00; } .text-yellow { color: #E6B800; }
        .bg-purple { background: #A020F0; } .text-purple { color: #A020F0; }
        .bg-white { background: #FFFFFF; border: 1px solid #E1E5EA; } .text-white { color: #666; }
        
        /* TABLE / CARDS */
        .data-table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            background: var(--card-bg); border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            table-layout: fixed;
            margin-bottom: 40px;
        }
        .data-table th {
            background: #FAFBFC; padding: 15px; text-align: left; font-weight: 600; 
            color: var(--text-sub); border-bottom: 1px solid var(--border-color);
        }
        .data-table td {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            vertical-align: middle; word-break: break-all;
        }
        
        /* Row States */
        .race-row { cursor: pointer; transition: background-color 0.1s; }
        .race-row:hover { background-color: #F9FAFB; }
        .race-row.expanded { background-color: #fff; border-left: 6px solid var(--primary-color); }
        .race-row.active-running { border-left: 6px solid var(--success-color); background-color: #FDFDFD; }
        .race-row.active-review { border-left: 6px solid var(--secondary-color); background-color: #F9F9FF; }
        .race-row.finished { background-color: #FAFBFC; color: #AAA; border-left: 6px solid #E1E5EA; }

        /* BUTTONS */
        .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-weight: 600; color: #555; }
        .btn-sm:hover { background: #f5f5f5; }
        .btn-outline { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .btn-primary { background: var(--primary-color); color: white; border: none; }
        
        .setup-btn-group .btn-sm { margin-left: 5px; }

        /* Big Action Buttons */
        .action-btn-col { display: flex; flex-direction: column; gap: 8px; height: 100%; justify-content: stretch; }
        .btn-reconnect { background: #EEF2F5; color: var(--info-color); border: 1px solid #DDE2E8; border-radius: 10px; padding: 8px; font-weight: bold; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; }
        .btn-reconnect:hover { background: #E5EAEE; }

        .btn-big-start { flex: 1; background: var(--primary-color); color: white; font-size: 16px; font-weight: bold; border-radius: 10px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(243, 139, 0, 0.3); transition: background 0.2s; min-height: 50px; }
        .btn-big-start:hover { background: var(--primary-hover); }
        .btn-big-stop { width: 100%; height: 100%; background: var(--danger-color); color: white; font-size: 18px; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3); }
        .btn-big-close { width: 100%; height: 100%; background: var(--secondary-color); color: white; font-size: 16px; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; animation: pulse 2s infinite; }
        .btn-big-reset { width: 100%; height: 100%; background: #8E8E93; color: white; font-size: 16px; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .btn-add-new { width: 100%; padding: 15px; margin-top: 15px; background: var(--primary-color); color: white; font-weight: bold; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 10px rgba(243, 139, 0, 0.3); }
        .btn-add-new:hover { background: var(--primary-hover); }

        /* PROGRESS BAR */
        .progress-container { height: 32px; background: #E1E5EA; border-radius: 16px; margin-top: 15px; position: relative; overflow: visible; }
        .progress-fill { height: 100%; background: rgba(243, 139, 0, 0.2); border-radius: 16px; width: 0%; transition: width 0.1s linear; }
        .pacer-head { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; transition: left 0.1s linear; }
        .pacer-head-label { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; background: white; padding: 2px 6px; border-radius: 4px; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #333; }
        .history-tick { position: absolute; top: 6px; bottom: 6px; width: 2px; z-index: 5; }
        .history-tick-label { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; background: rgba(255,255,255,0.95); padding: 1px 4px; border-radius: 3px; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* INLINE CONTROLLER */
        .inline-controller { padding: 15px; background: #FAFBFC; border-radius: 12px; margin-top: 15px; border: 1px solid #F0F0F0; cursor: default; }
        .pacer-control-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #EEF2F5; min-height: 50px;}
        .pacer-control-row:last-child { border-bottom: none; }
        .dot-large { width: 28px; height: 28px; border-radius: 50%; border: 3px solid rgba(0,0,0,0.05); display: inline-block;}
        
        .pacer-adjust { display: flex; align-items: center; gap: 8px; flex: 1; }
        .btn-adjust { width: 44px; height: 44px; border-radius: 50%; border: 1px solid #E1E5EA; background: white; font-size: 24px; color: #555; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.1s; }
        .btn-adjust:active { background: #f0f0f0; transform: scale(0.95); }
        .btn-adjust:disabled { background: #F5F5F5; color: #CCC; cursor: not-allowed; border-color: #EEE;}
        .pace-input { font-family: monospace; font-size: 24px; font-weight: bold; width: 90px; text-align: center; border: 2px solid transparent; background: transparent; border-radius: 8px; color: var(--text-main); }
        .pace-input:focus { border-color: var(--primary-color); background: white; outline: none; }
        .pace-input.changed { color: var(--danger-color); background: #FFF5F5; border-color: var(--danger-color); }
        .pace-input:disabled { color: #AAA; -webkit-text-fill-color: #AAA; opacity: 1; }
        .btn-commit-group { display: flex; gap:5px; margin-left: 10px; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        .btn-commit-group.visible { visibility: visible; opacity: 1; }
        .btn-commit { background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #E1E5EA; color: #555; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .pacer-est-time { margin-left: auto; font-family: monospace; font-size: 15px; color: var(--text-sub); text-align: right; min-width: 120px;}
        .avg-pace-label { font-size: 11px; color: #8E8E93; margin-top: 2px; display:block; text-align: center; }
        
        .race-control-layout { display: grid; grid-template-columns: 1fr 140px; gap: 20px; align-items: stretch; }
        .timer-big { font-size: 36px; font-family: monospace; font-weight: bold; line-height: 1; color: var(--text-main); }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; margin-left: 10px;}
        .status-ready { background: #F2F2F7; color: #8E8E93; }
        .status-running { background: #E6F9EB; color: #4CD964; border: 1px solid #4CD964; }
        .status-review { background: #ECECF9; color: #5856D6; border: 1px solid #5856D6;}
        .status-finished { background: #F2F2F7; color: #AAA; }

        /* INPUTS */
        .title-input { font-size: 20px; font-weight: bold; padding: 8px; width: 100%; border: 1px solid transparent; border-radius: 8px; background: transparent; color: var(--text-main); }
        .title-input:hover { background: #F7F7F9; }
        .title-input:focus { background: #fff; border-color: var(--primary-color); outline: none; }
        .setup-card { background: #fff; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .input-cell { width: 90%; padding: 10px; border: 1px solid #E1E5EA; border-radius: 8px; font-size: 15px; background: #FAFBFC; }
        .input-cell:focus { background: #fff; border-color: var(--primary-color); outline: none; }
        .input-start { width: 60px; text-align: center; font-weight: bold; color: var(--info-color); }

        /* --- DEVICES SCREEN --- */
        .device-settings-panel {
            background: #FAFBFC; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #E1E5EA;
            display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;
        }
        .setting-group { display: flex; flex-direction: column; gap: 5px; }
        .setting-label { font-size: 11px; font-weight: bold; color: #8E8E93; text-transform: uppercase; }
        .setting-input { padding: 8px 12px; border-radius: 8px; border: 1px solid #DDE2E8; font-size: 16px; font-weight: bold; width: 100px; }
        .setting-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #DDE2E8; font-size: 16px; font-weight: bold; width: 120px; background: white; }

        /* GRID VIEW */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            padding: 10px;
        }
        .device-cell {
            background: #FFF; border: 1px solid #E1E5EA; border-radius: 8px;
            padding: 8px; cursor: pointer; position: relative;
            min-height: 60px; display: flex; flex-direction: column; justify-content: space-between;
            transition: all 0.1s;
        }
        .device-cell:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--primary-color); }
        
        .cell-header { display: flex; justify-content: space-between; font-size: 10px; color: #8E8E93; margin-bottom: 4px; }
        .cell-id { font-weight: bold; }
        .cell-mac { font-family: monospace; font-size: 11px; font-weight: bold; color: #333; text-align: center; background: #F2F2F7; padding: 2px; border-radius: 4px; }
        
        /* States */
        .cell-active { border-left: 4px solid var(--success-color); }
        .cell-dummy { border-left: 4px solid #FFCC00; background: #FFFDF5; }
        .cell-empty { border: 1px dashed #CCC; background: #FAFAFA; opacity: 0.7; }
        
        .highlight-blink { animation: blinkAnim 0.5s 2; background-color: var(--primary-color) !important; color: white; }
        @keyframes blinkAnim { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .menu-btn { width: 100%; padding: 12px; text-align: left; background: white; border: 1px solid #EEE; border-radius: 8px; margin-bottom: 5px; font-size: 14px; cursor: pointer; font-weight: bold; color: #444; }
        .menu-btn:hover { background: #F9F9F9; }
        .menu-btn.btn-danger { color: var(--danger-color); border-color: #FFEEEE; background: #FFF5F5; }

        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 500px; border-radius: 20px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
        .pacer-chip { display: inline-flex; align-items: center; padding: 6px 10px; border-radius: 20px; background: #F7F7F9; border: 1px solid #E1E5EA; margin-right: 5px; margin-bottom: 4px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .pacer-chip:hover { border-color: var(--primary-color); background: #FFFBF5; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 6px; }
        .color-selector { display: flex; gap: 15px; margin: 15px 0; }
        .color-option { width: 44px; height: 44px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-option.selected { border-color: #333; transform: scale(1.1); }
        .mac-list-title { font-size: 12px; color: #8E8E93; margin: 15px 0 5px 0; font-weight: bold; }
        .mac-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #F0F0F0; }
        .mac-addr { font-family: monospace; font-size: 14px; font-weight: bold; color: #333; }
        .btn-connect { background: #EEF2F5; color: var(--info-color); border: 1px solid #DDE2E8; padding: 6px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .btn-connect:hover { background: #E5EAEE; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="image_c2633c.png" alt="Logo" class="logo-mark">
        <div class="system-title">Glow-Rabbit for race</div>
    </div>
    <div class="header-right">
        <div class="ble-status">‚óè BLEÊú™Êé•Á∂ö</div>
        <button class="btn-sm btn-connect" onclick="connectBLE()">üì° Êé•Á∂ö</button>
        <button class="btn-sm" style="border:none; background:transparent; font-size:18px; cursor:pointer;" onclick="openVersionModal()">‚öôÔ∏è</button>
        <div class="mode-switch">
            <button class="mode-btn" id="btn-mode-setup" onclick="switchMode('setup')">Ë®≠ÂÆö</button>
            <button class="mode-btn active" id="btn-mode-race" onclick="switchMode('race')">ÂÆüË°å</button>
            <button class="mode-btn" id="btn-mode-devices" onclick="switchMode('devices')">Ë®≠ÁΩÆ</button>
        </div>
    </div>
</header>

<main>
    <div id="screen-setup" class="screen">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1; margin-right:20px;">
                    <label style="font-size:11px; color:#8E8E93; display:block; margin-bottom:2px;">Â§ß‰ºöÂêç</label>
                    <input type="text" class="title-input" id="competition-title" value="Á¨¨74ÂõûÂ±±ÂΩ¢ÁúåÈï∑Ë∑ùÈõ¢Ë®òÈå≤‰ºö" onchange="saveCompetitionTitle(this.value)">
                </div>
                <div class="setup-btn-group">
                    <button class="btn-sm btn-outline" onclick="alert('CSVË™≠Ëæº')">üìÇ CSVË™≠Ëæº</button>
                    <button class="btn-sm btn-outline" onclick="alert('Â±•Ê≠¥Âëº„Å≥Âá∫„Åó')">üìã Â±•Ê≠¥</button>
                    <button class="btn-sm btn-outline" onclick="alert('Â±•Ê≠¥„Åã„ÇâÊñ∞Ë¶è')">üìë „Ç≥„Éî„ÉºÊñ∞Ë¶è</button>
                    <button class="btn-sm btn-danger" onclick="if(confirm('„ÇØ„É™„Ç¢?')){races=[];renderSetup();}">üóë „ÇØ„É™„Ç¢</button>
                </div>
            </div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width:90px;">ÊôÇÂàª</th><th>Á®ÆÁõÆÂêç</th><th style="width:50px;">ÁµÑ</th>
                    <th style="width:70px;">Ë∑ùÈõ¢m</th><th style="width:70px;">Start(m)</th>
                    <th style="width:50px;">‰∫∫Êï∞</th><th>„Éö„Éº„Çµ„ÉºË®≠ÂÆö</th><th style="width:60px;"></th>
                </tr>
            </thead>
            <tbody id="setup-tbody"></tbody>
        </table>
        <button class="btn-add-new" onclick="addNewRow()">Ôºã Êñ∞„Åó„ÅÑ„É¨„Éº„Çπ„Çí‰ΩúÊàê</button>
    </div>

    <div id="screen-race" class="screen active">
        <div id="race-screen-title" style="font-size:24px; font-weight:bold; margin-bottom:20px; padding-left:10px; border-left:6px solid var(--primary-color); color:var(--text-main);"></div>
        <div style="margin-bottom:10px; color:#8E8E93; font-size:13px; text-align:right;">Ë°å„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíÂ±ïÈñã</div>
        <table class="data-table">
            <tbody id="race-tbody"></tbody>
        </table>
    </div>

    <div id="screen-devices" class="screen">
        <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:24px; color:var(--primary-color);">„Éá„Éê„Ç§„ÇπË®≠ÁΩÆ</h2>
            <div style="text-align:right;">
                <div id="device-sync-status" class="status-badge status-clean" style="font-size:12px; margin-bottom:4px;">‚úì ÂêåÊúüÂÆå‰∫Ü</div>
                <div style="font-size:11px; color:#888;">Ë®≠ÁΩÆÊï∞: <span id="device-count-display">0 / 0</span></div>
            </div>
        </div>

        <div class="device-settings-panel">
            <div class="setting-group">
                <label class="setting-label">Á∑èË∑ùÈõ¢ (m)</label>
                <input type="number" id="setting-distance" class="setting-input" value="400" step="100" onchange="updateRaceSettings(this.value, null)">
            </div>
            <div class="setting-group">
                <label class="setting-label">ÈñìÈöî (m)</label>
                <select id="setting-interval" class="setting-select" onchange="updateRaceSettings(null, this.value)">
                    <option value="1">1m</option>
                    <option value="2" selected>2m</option>
                    <option value="4">4m</option>
                    <option value="5">5m</option>
                </select>
            </div>
            <div style="flex:1; display:flex; justify-content:flex-end; gap:10px; padding-bottom:5px;">
                <button class="btn-sm btn-outline" onclick="fillWithDummy()">Ôºã ÊÆã„Çä„Çí„ÉÄ„Éü„Éº„ÅßÂüã„ÇÅ„Çã</button>
                <button class="btn-sm btn-outline" onclick="downloadCSV()">‚¨á CSVÂá∫Âäõ</button>
                <button class="btn-sm btn-outline" onclick="document.getElementById('csv-input').click()">‚¨Ü CSVÂèñËæº</button>
                <input type="file" id="csv-input" style="display:none" onchange="importCSV(this)" accept=".csv">
                <button class="btn-sm btn-danger" onclick="clearDeviceList()">üóë ÂÖ®ÂâäÈô§</button>
                <button class="btn-sm btn-primary" onclick="syncAllDevices()">üîÑ ÂêåÊúü</button>
            </div>
        </div>

        <div style="margin-bottom:10px; background:#FFF3CD; padding:10px; border-radius:8px; font-size:13px; color:#856404;">
            ‚Äª <strong>ÁôªÈå≤ÊñπÊ≥ï:</strong> Glow-RÊú¨‰Ωì„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®Ëá™ÂãïËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ<br>
            ‚Äª <strong>Êìç‰Ωú:</strong> „Éû„Çπ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Äå„ÉÜ„Çπ„ÉàÁÇπÁÅØ„Äç„Äå„ÉÄ„Éü„ÉºÂåñ„Äç„Äå‰∫§Êèõ„Äç„É°„Éã„É•„Éº„ÅåÈñã„Åç„Åæ„Åô„ÄÇ
        </div>
        
        <div id="device-list-container">
            <!-- Grid Rendered by JS -->
        </div>
    </div>
</main>

<div id="modal-settings" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">„Éö„Éº„Çµ„ÉºË®≠ÂÆö</h3>
        <div class="color-selector">
            <div class="color-option bg-red" onclick="selectModalColor('red')"></div>
            <div class="color-option bg-blue" onclick="selectModalColor('blue')"></div>
            <div class="color-option bg-green" onclick="selectModalColor('green')"></div>
            <div class="color-option bg-yellow" onclick="selectModalColor('yellow')"></div>
            <div class="color-option bg-purple" onclick="selectModalColor('purple')"></div>
            <div class="color-option bg-white" onclick="selectModalColor('white')"></div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; margin:30px 0;">
            <input type="number" id="modal-pace-input" step="0.1" value="72.0" style="font-size:32px; width:120px; text-align:right; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <span style="font-size:16px; font-weight:bold; color:#888;">Áßí / 400m</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-sm btn-danger" style="border:none; background:#FFF0F0;" onclick="deletePacerFromModal()">ÂâäÈô§</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-outline" style="border:none; background:#F2F2F7; color:#555;" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn-sm btn-primary" style="padding:10px 24px; font-size:14px;" onclick="saveModalData()">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-version" class="modal-overlay" onclick="if(event.target===this) closeVersionModal()">
    <div class="modal-content" style="text-align:center; width:300px;">
        <img src="image_c2633c.png" style="width:60px; margin-bottom:10px;">
        <h3>Glow-Rabbit Web</h3>
        <p style="color:#888; font-family:monospace;">Version: 1.3.6</p>
        <p style="color:#CCC; font-size:12px;">Revision: 20251128-RESTORE-GLOBAL</p>
        <button class="btn-sm btn-primary" onclick="closeVersionModal()">Èñâ„Åò„Çã</button>
    </div>
</div>

<script src="ble_protocol.js"></script>
<script src="app.js"></script>
<script>
    // --- GLOBAL STATE RECOVERY ---
    let races = [];
    let activeRaceId = null;
    let expandedRaceId = null;
    let editingPaces = {}; // { pacerId: tempValue }
    let elapsedTime = 0;
    let raceInterval = null;
    
    // Modal State
    let modalTarget = {}; 
    let modalSelectedColor = 'red';

    function loadRaces() {
        const saved = localStorage.getItem('glow_races');
        if (saved) {
            try {
                races = JSON.parse(saved);
                // Reset volatile states
                races.forEach(r => {
                    if(r.status === 'running') r.status = 'ready'; // Crash recovery
                    r.markers = r.markers || [];
                });
            } catch(e) { console.error("Load Error:", e); }
        }
        if(!races) races = [];
    }

    function saveRaces() {
        localStorage.setItem('glow_races', JSON.stringify(races));
    }

    let currentMode = 'race'; // Default

    window.onload = function() { 
        loadRaces();
        loadAppState(); // New: Load Title & Mode
        
        // Initial Render
        renderSetup(); 
        renderRace(); 
        
        // Switch to saved mode
        if(currentMode && currentMode !== 'race') {
            switchMode(currentMode, true); // true = skip guard for initial load
        }

        // renderDevices is now handled by app.js, but we ensure grid is ready
        if(window.deviceList) renderDeviceList();
    };
    
    function loadAppState() {
        const savedTitle = localStorage.getItem('glow_competition_title');
        if(savedTitle) document.getElementById('competition-title').value = savedTitle;
        
        const savedMode = localStorage.getItem('glow_current_mode');
        if(savedMode && ['setup','race','devices'].includes(savedMode)) {
            currentMode = savedMode;
        } else {
            currentMode = 'race';
        }
    }
    
    function saveCompetitionTitle(val) {
        localStorage.setItem('glow_competition_title', val);
        document.getElementById('race-screen-title').innerText = val;
    }

    async function switchMode(mode, skipGuard = false) {
        // Check if target exists
        if (!document.getElementById('screen-'+mode)) {
            console.error("Target screen not found:", mode);
            return;
        }

        // Guard: If leaving devices screen, check for dirty state
        try {
            if (!skipGuard && document.getElementById('screen-devices').classList.contains('active') && mode !== 'devices') {
                if (window.checkDirtyAndSync) {
                    const proceed = await window.checkDirtyAndSync();
                    if (!proceed && window.isListDirty) return; 
                }
            }
        } catch(e) {
            console.warn("Guard check failed, proceeding anyway:", e);
        }

        // Guard: If leaving race screen while running
        try {
            if (!skipGuard && document.getElementById('screen-race').classList.contains('active') && mode !== 'race') {
                if (activeRaceId !== null) {
                    const r = races.find(x => x.id === activeRaceId);
                    if (r && r.status === 'running') {
                        if (!confirm("„É¨„Éº„ÇπÂÆüË°å‰∏≠„Åß„Åô„ÄÇÂÅúÊ≠¢„Åó„Å¶ÁîªÈù¢„ÇíÁßªÂãï„Åó„Åæ„Åô„ÅãÔºü")) return;
                        stopRaceWrapper(activeRaceId);
                    }
                }
            }
        } catch(e) {
            console.warn("Race guard failed:", e);
        }

        // Change UI
        document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.mode-btn').forEach(e=>e.classList.remove('active'));
        
        const targetScreen = document.getElementById('screen-'+mode);
        const targetBtn = document.getElementById('btn-mode-'+mode);
        
        if(targetScreen) targetScreen.classList.add('active');
        if(targetBtn) targetBtn.classList.add('active');
        
        currentMode = mode;
        localStorage.setItem('glow_current_mode', mode);

        if(mode==='setup') renderSetup();
        if(mode==='race') {
            const titleEl = document.getElementById('competition-title');
            if(titleEl) document.getElementById('race-screen-title').innerText = titleEl.value;
            renderRace();
        }
        if(mode==='devices') {
            if(window.renderDeviceList) window.renderDeviceList();
        }
    }

    // --- RACE LOGIC ---
    function toggleRow(id, event) {
        if (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT') return;
        if (expandedRaceId === id) expandedRaceId = null;
        else expandedRaceId = id;
        renderRace();
    }

    function renderRace() {
        const tbody = document.getElementById('race-tbody');
        tbody.innerHTML = '';
        races.forEach(r => {
            const tr = document.createElement('tr');
            let rowClass = 'race-row';
            if (r.id === expandedRaceId) rowClass += ' expanded';
            if (r.status === 'running') rowClass += ' active-running';
            if (r.status === 'review') rowClass += ' active-review';
            if (r.status === 'finished') rowClass += ' finished';
            tr.className = rowClass;
            tr.onclick = (e) => toggleRow(r.id, e);

            let content = '';
            const isExpanded = (r.id === expandedRaceId);
            let badge = '';
            if(r.status === 'ready') badge = '<span class="status-badge status-ready">ÂæÖÊ©ü</span>';
            if(r.status === 'running') badge = '<span class="status-badge status-running">ÂÆüË°å‰∏≠</span>';
            if(r.status === 'review') badge = '<span class="status-badge status-review">Ë®òÈå≤Á¢∫Ë™ç</span>';
            if(r.status === 'finished') badge = '<span class="status-badge status-finished">ÂÆå‰∫Ü</span>';

            if (!isExpanded) {
                let chips = r.pacers.map(p => `<span class="pacer-chip"><span class="dot bg-${p.color}"></span>${p.pace}s</span>`).join(' ');
                content = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong style="font-size:16px;">${r.time} ${r.name}</strong> 
                            <span style="color:#8E8E93; margin-left:10px;">${r.group}ÁµÑ (${r.distance}m)</span>
                            ${badge}
                            <div style="margin-top:8px;">${chips}</div>
                        </div>
                        <div style="color:#C6C6C8; font-size:20px;">‚ñº</div>
                    </div>`;
            } else {
                let pacerRows = r.pacers.map(p => {
                    const isEditing = editingPaces[p.id] !== undefined;
                    const displayPace = isEditing ? editingPaces[p.id] : p.pace;
                    const valClass = isEditing ? "pace-input changed" : "pace-input";
                    const btnGroupClass = isEditing ? "btn-commit-group visible" : "btn-commit-group";
                    
                    let estStr = "--:--";
                    let avgPace = 0;
                    
                    if (p.finishTime !== null) {
                        estStr = `Goal (${formatTime(p.finishTime)})`;
                        avgPace = (p.finishTime / r.distance) * 400; 
                    } else if (r.status === 'ready') {
                        let speed = 400 / displayPace; 
                        let estSec = r.distance / speed;
                        estStr = `Est (${formatTime(estSec)})`;
                    } else {
                        const speed = 400 / displayPace; 
                        const remDist = r.distance - p.currentDist;
                        const remSec = remDist / speed;
                        estStr = formatTime(elapsedTime + remSec);
                        if(p.currentDist > 0) avgPace = (elapsedTime / p.currentDist) * 400;
                    }
                    let avgLabel = (avgPace > 0 && r.status !== 'ready') ? `<span class="avg-pace-label">Avg: ${avgPace.toFixed(1)}</span>` : "";
                    // Disable controls if running, review, or finished (Race Mode is strict)
                    const isDisabled = (r.status === 'running' || r.status === 'review' || r.status === 'finished');

                    return `
                    <div class="pacer-control-row" onclick="event.stopPropagation()">
                        <div class="pacer-info"><span class="dot-large bg-${p.color}"></span></div>
                        <div class="pacer-adjust">
                            <button class="btn-adjust" ${isDisabled?'disabled':''} onclick="adjustPace(${p.id}, 0.5)">+</button>
                            <div><input type="number" class="${valClass}" id="pace-input-${p.id}" value="${displayPace}" step="0.1" ${isDisabled?'disabled':''} onfocus="startEditing(${p.id}, this.value)" oninput="updateEditValue(${p.id}, this.value)">${avgLabel}</div>
                            <button class="btn-adjust" ${isDisabled?'disabled':''} onclick="adjustPace(${p.id}, -0.5)">‚àí</button>
                            <div class="${btnGroupClass}" id="btn-group-${p.id}"><button class="btn-cancel" onclick="cancelPace(${r.id}, ${p.id})">‚úñ</button><button class="btn-commit" onclick="commitPace(${r.id}, ${p.id})">Á¢∫ÂÆö</button></div>
                        </div>
                        <div class="pacer-est-time">${estStr}</div>
                    </div>`;
                }).join('');

                const totalScale = r.distance + 50;
                let headsHtml = r.pacers.map(p => {
                    let leftPct = Math.min(((p.currentDist + r.startPos) / (totalScale + r.startPos)) * 100, 100);
                    leftPct = Math.min((p.currentDist / totalScale) * 100, 100);
                    return `<div class="pacer-head bg-${p.color}" style="left:${leftPct}%"><div class="pacer-head-label" style="color:${p.color==='yellow'?'black':'var(--primary-color)'}">${Math.floor(p.currentDist)}m</div></div>`;
                }).join('');
                let marksHtml = r.markers.map(m => {
                    let leftPct = (m.dist / totalScale) * 100;
                    return `<div class="history-tick bg-${m.color}" style="left:${leftPct}%"><div class="history-tick-label text-${m.color}">${m.pace}</div></div>`;
                }).join('');
                let maxDist = Math.max(...r.pacers.map(p=>p.currentDist));
                let fillPct = Math.min((maxDist / totalScale) * 100, 100);

                let btnArea = "";
                let infoHeader = "";
                
                if (r.status === 'ready') {
                    let isLocked = (activeRaceId !== null && activeRaceId !== r.id);
                    // Integrate JS Call to start race
                    btnArea = `
                        <div class="action-btn-col">
                            <button class="btn-reconnect" onclick="event.stopPropagation(); if(connectBLE) connectBLE();">üì° BLEÊé•Á∂ö</button>
                            <button class="btn-big-start" style="${isLocked?'opacity:0.5; pointer-events:none;':''}" onclick="event.stopPropagation(); startRaceWrapper(${r.id})">START</button>
                        </div>`;
                    infoHeader = `
                        <div style="display:flex; align-items:flex-end; gap:10px;">
                            <div class="timer-big" style="color:#DDD;">00:00.0</div>
                            <div style="margin-bottom:5px;">
                                <label style="font-size:12px; color:#8E8E93;">Start:</label>
                                <input type="number" value="${r.startPos}" style="width:50px; border:1px solid #ddd; border-radius:4px; text-align:center;" onchange="updateStartPos(${r.id}, this.value)"> m
                            </div>
                        </div>`;
                } else if (r.status === 'running') {
                    btnArea = `<button class="btn-big-stop" onclick="event.stopPropagation(); stopRaceWrapper(${r.id})">STOP</button>`;
                    infoHeader = `<div class="timer-big" id="timer-display">${formatTime(elapsedTime)}</div>`;
                } else if (r.status === 'review') {
                    btnArea = `<button class="btn-big-close" onclick="event.stopPropagation(); finalizeRace(${r.id})">Èñâ„Åò„Çã<br><small>Ë®òÈå≤ÂÆå‰∫Ü</small></button>`;
                    infoHeader = `<div class="timer-big">${formatTime(elapsedTime)}</div>`;
                } else if (r.status === 'finished') {
                    btnArea = `<button class="btn-big-reset" onclick="event.stopPropagation(); resetRace(${r.id})">„É™„Çª„ÉÉ„Éà</button>`;
                    infoHeader = `<div style="color:#AAA; font-weight:bold;">Ë®òÈå≤Ê∏à„Åø</div>`;
                }

                content = `
                    <div style="border-bottom:1px solid #F0F0F0; padding-bottom:15px; margin-bottom:15px; display:flex; align-items:center; justify-content:space-between;">
                         <div>
                            <span style="font-size:20px; font-weight:bold;">${r.time} ${r.name}</span>
                            <span style="color:#8E8E93; margin-left:10px;">${r.group}ÁµÑ (${r.distance}m)</span>
                             ${badge}
                         </div>
                         <button style="border:none; background:none; color:#CCC; font-size:18px;">‚ñ≤</button>
                    </div>
                    <div class="race-control-layout" onclick="event.stopPropagation()">
                        <div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px;">
                                ${infoHeader}
                                <div style="color:var(--text-main);">ÂÖàÈ†≠: <strong style="font-size:18px;">${Math.floor(maxDist)}</strong>m</div>
                            </div>
                            <div class="progress-container">
                                <div class="progress-fill" style="width:${fillPct}%"></div>
                                ${headsHtml} ${marksHtml}
                            </div>
                            <div class="inline-controller">${pacerRows}</div>
                        </div>
                        <div>${btnArea}</div>
                    </div>`;
            }
            tr.innerHTML = `<td>${content}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Wrapper to call BLE functions
    function startRaceWrapper(id) {
        const r = races.find(x => x.id === id);
        // Send BLE Config (Color & Pace for all pacers)
        // Fix: use sendPaceConfig if sendRaceConfig is not exposed
        if(window.sendRaceConfig) window.sendRaceConfig(r.distance, r.pacers);
        else if(window.sendPaceConfig) window.sendPaceConfig(r.distance, r.pacers);
        
        // Send BLE Start Command (with Start Position)
        if(window.sendStartRace) window.sendStartRace(r.pacers, r.startPos);
        
        // Start UI Animation
        startRace(id);
    }
    
    function stopRaceWrapper(id) {
        if(window.sendStopRace) window.sendStopRace();
        freezeRace(id);
    }

    // --- LOGIC FUNCTIONS ---
    function updateStartPos(id, val) {
        const r = races.find(x=>x.id===id);
        r.startPos = parseInt(val) || 0;
        saveRaces();
    }

    function startRace(id) {
        if(activeRaceId && activeRaceId !== id) return alert("‰ªñ„ÅÆ„É¨„Éº„Çπ„ÅåÂÆüË°å‰∏≠„Åß„Åô");
        activeRaceId = id;
        const r = races.find(x=>x.id===id);
        r.status = 'running';
        r.markers = [];
        r.pacers.forEach(p => { p.currentDist=0; p.finishTime=null; });
        elapsedTime = 0; editingPaces = {};
        r.pacers.forEach(p => {
            const inp = document.getElementById(`pace-input-${p.id}`);
            if(inp) p.pace = parseFloat(inp.value);
        });
        saveRaces();
        
        // Init Calibration logic for this race (Defined in app.js)
        if(window.initCalibration) window.initCalibration(r);

        // UI Animation Loop
        renderRace();
        raceInterval = setInterval(() => updateState(r), 100);
    }

    function updateState(race) {
        elapsedTime += 0.1;
        let allFinished = true;
        const limit = race.distance + 50;
        
        // Run Calibration Check (Defined in app.js)
        if(window.checkAndCalibrate && race.status === 'running') {
             window.checkAndCalibrate(race, elapsedTime);
        }

        race.pacers.forEach(p => {
            if (p.currentDist < limit) {
                let speed = 400.0 / p.pace;
                p.currentDist += (speed * 0.1);
                allFinished = false;
                if (p.currentDist >= race.distance && p.finishTime === null) p.finishTime = elapsedTime;
            } else {
                 if (p.finishTime === null) p.finishTime = elapsedTime;
            }
        });
        updateDom(race);
        if(allFinished) {
             // Send Stop Command to BLE to ensure lights are off/stopped
             if(window.sendStopRace) window.sendStopRace();
             freezeRace(race.id);
        }
    }

    function updateDom(race) {
        const tEl = document.getElementById('timer-display');
        if(tEl) tEl.innerText = formatTime(elapsedTime);
        const totalScale = race.distance + 50;
        const heads = document.querySelectorAll('.pacer-head');
        let maxDist = 0;
        race.pacers.forEach((p, idx) => {
            if(p.currentDist > maxDist) maxDist = p.currentDist;
            if(heads[idx]) {
                let pct = Math.min((p.currentDist / totalScale) * 100, 100);
                heads[idx].style.left = pct + '%';
                heads[idx].querySelector('.pacer-head-label').innerText = Math.floor(p.currentDist) + "m";
            }
        });
        const fill = document.querySelector('.progress-fill');
        if(fill) fill.style.width = Math.min((maxDist / totalScale) * 100, 100) + '%';
    }

    function freezeRace(id) { clearInterval(raceInterval); const r = races.find(x=>x.id===id); r.status = 'review'; renderRace(); saveRaces(); }
    function finalizeRace(id) { const r = races.find(x=>x.id===id); r.status = 'finished'; activeRaceId = null; expandedRaceId = null; renderRace(); saveRaces(); }
    function resetRace(id) { const r = races.find(x=>x.id===id); r.status = 'ready'; r.pacers.forEach(p=>{ p.currentDist=0; p.finishTime=null; }); renderRace(); saveRaces(); }

    function startEditing(pid, v) { editingPaces[pid]=parseFloat(v); updateUI(pid); }
    function updateEditValue(pid, v) { editingPaces[pid]=parseFloat(v); updateUI(pid); }
    function adjustPace(pid, d) { let cur = editingPaces[pid]!==undefined ? editingPaces[pid] : getBasePace(pid); editingPaces[pid] = parseFloat((cur+d).toFixed(1)); document.getElementById('pace-input-'+pid).value = editingPaces[pid]; updateUI(pid); }
    function updateUI(pid) { document.getElementById('pace-input-'+pid).classList.add('changed'); document.getElementById('btn-group-'+pid).classList.add('visible'); }
    function cancelPace(rid, pid) { delete editingPaces[pid]; const p = getPacer(rid, pid); const inp = document.getElementById('pace-input-'+pid); inp.value = p.pace; inp.classList.remove('changed'); document.getElementById('btn-group-'+pid).classList.remove('visible'); }
    function commitPace(rid, pid) { const p = getPacer(rid, pid); if(editingPaces[pid]!==undefined) { const r = races.find(x=>x.id===rid); const isRunning = (r.status === 'running'); p.pace = editingPaces[pid]; delete editingPaces[pid]; if(isRunning) { r.markers.push({ dist: p.currentDist, time: elapsedTime, pace: p.pace, color: p.color }); } renderRace(); saveRaces(); } }
    function getBasePace(pid) { for(let r of races) { let p = r.pacers.find(x=>x.id===pid); if(p) return p.pace; } return 72.0; }
    function getPacer(rid, pid) { return races.find(r=>r.id===rid).pacers.find(p=>p.id===pid); }

    // SETUP & UTILS
    function renderSetup() {
        const tb = document.getElementById('setup-tbody'); tb.innerHTML='';
        races.forEach(r=>{
            let ph = r.pacers.map(p=>`<span class="pacer-chip" onclick="openModal(${r.id},${p.id})"><span class="dot bg-${p.color}"></span>${p.pace}s</span>`).join('');
            tb.innerHTML += `<tr>
                <td><input type="time" class="input-cell" value="${r.time}" onchange="updateData(${r.id}, 'time', this.value)"></td>
                <td><input type="text" class="input-cell" value="${r.name}" onchange="updateData(${r.id}, 'name', this.value)"></td>
                <td><input type="number" class="input-cell" value="${r.group}" onchange="updateData(${r.id}, 'group', this.value)"></td>
                <td><input type="number" class="input-cell" value="${r.distance}" onchange="updateData(${r.id}, 'distance', this.value)"></td>
                <td><input type="number" class="input-cell input-start" value="${r.startPos}" onchange="updateData(${r.id}, 'startPos', this.value)"></td>
                <td><input type="number" class="input-cell" value="${r.count}" onchange="updateData(${r.id}, 'count', this.value)"></td>
                <td>${ph} <button class="btn-sm btn-outline" onclick="openModal(${r.id},null)">Ôºã</button></td>
                <td><button class="btn-sm btn-danger" style="border:none; background:#FFF0F0;" onclick="deleteRow(${r.id})">ÂâäÈô§</button></td>
            </tr>`;
        });
    }
    // AUTO CALC START POS
    function updateData(id, f, v) { 
        const r = races.find(x=>x.id===id); 
        if(r) {
            if(f==='distance') {
                let d = parseInt(v)||0;
                r.distance = d;
                // Auto Calc: 400 - mod(dist/400)
                let mod = d % 400;
                r.startPos = (mod === 0) ? 0 : (400 - mod);
                saveRaces();
                renderSetup(); // Re-render to show start pos
            } else {
                r[f] = (f==='count'||f==='group'||f==='startPos')?parseInt(v)||0:v; 
                saveRaces();
            }
        } 
    }
    function addNewRow() { races.push({id:Date.now(), time:"10:00", name:"New Race", group:1, distance:1000, startPos:200, count:10, status:"ready", pacers:[], markers:[]}); saveRaces(); renderSetup(); }
    function deleteRow(id) { if(confirm("ÂâäÈô§?")){races=races.filter(r=>r.id!==id); saveRaces(); renderSetup();} }
    function openModal(rid, pid) { modalTarget={raceId:rid, pacerId:pid}; const r=races.find(x=>x.id===rid); if(pid){ const p=r.pacers.find(x=>x.id===pid); selectModalColor(p.color); document.getElementById('modal-pace-input').value=p.pace; } else { selectModalColor('red'); document.getElementById('modal-pace-input').value=72.0; } document.getElementById('modal-settings').classList.add('open'); }
    function selectModalColor(c) { modalSelectedColor=c; document.querySelectorAll('.color-option').forEach(e=>e.classList.remove('selected')); document.querySelector('.bg-'+c).classList.add('selected'); }
    function saveModalData() { const r=races.find(x=>x.id===modalTarget.raceId); const v=parseFloat(document.getElementById('modal-pace-input').value); if(modalTarget.pacerId) { const p=r.pacers.find(x=>x.id===modalTarget.pacerId); p.color=modalSelectedColor; p.pace=v; } else { r.pacers.push({id:Date.now(), color:modalSelectedColor, pace:v, currentDist:0, finishTime:null}); } saveRaces(); closeModal(); renderSetup(); }
    function deletePacerFromModal() { if(modalTarget.pacerId && confirm('ÂâäÈô§?')) { const r=races.find(x=>x.id===modalTarget.raceId); r.pacers=r.pacers.filter(x=>x.id!==modalTarget.pacerId); saveRaces(); } closeModal(); renderSetup(); }
    function closeModal() { document.getElementById('modal-settings').classList.remove('open'); }
    function openVersionModal() { document.getElementById('modal-version').classList.add('open'); }
    function closeVersionModal() { document.getElementById('modal-version').classList.remove('open'); }
    function openReconnectModal() { document.getElementById('modal-reconnect').classList.add('open'); }
    function closeReconnectModal() { document.getElementById('modal-reconnect').classList.remove('open'); }
    function formatTime(s) { if(s<0) return "00:00.0"; let m=Math.floor(s/60), sec=Math.floor(s%60), ms=Math.floor((s*10)%10); return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}.${ms}`; }
</script>
</body>
</html>
