<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glow-Rabbit for Race v15 (Modular)</title>
    <link rel="icon" href="image_c2633c.png" type="image/png">
    <link rel="stylesheet" href="css/style.css?v=2.0.1">
</head>
<body>

<header>
    <div class="header-left">
        <img src="image_c2633c.png" alt="Logo" class="logo-mark">
        <div class="system-title">Glow-Rabbit for race</div>
    </div>
    <div class="header-right">
        <div class="ble-status">● BLE未接続</div>
        <button class="btn-sm btn-connect" onclick="connectBLE()">📡 接続</button>
        <button class="btn-sm" style="border:none; background:transparent; font-size:18px; cursor:pointer;" onclick="openVersionModal()">⚙️</button>
        <div class="mode-switch">
            <button class="mode-btn" id="btn-mode-setup">設定</button>
            <button class="mode-btn active" id="btn-mode-race">実行</button>
            <button class="mode-btn" id="btn-mode-devices">設置</button>
        </div>
    </div>
</header>

<main>
    <div id="screen-setup" class="screen">
        <div class="setup-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1; margin-right:20px;">
                    <label style="font-size:11px; color:#8E8E93; display:block; margin-bottom:2px;">大会名</label>
                    <input type="text" class="title-input" id="competition-title" value="第74回山形県長距離記録会" onchange="saveCompetitionTitle(this.value)">
                </div>
                <div class="setup-btn-group">
                    <button class="btn-sm btn-outline" onclick="alert('CSV読込')">📂 CSV読込</button>
                    <button class="btn-sm btn-outline" onclick="alert('履歴呼び出し')">📋 履歴</button>
                    <button class="btn-sm btn-outline" onclick="alert('履歴から新規')">📑 コピー新規</button>
                    <button class="btn-sm btn-danger" onclick="if(confirm('クリア?')){clearRaces();}">🗑 クリア</button>
                </div>
            </div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width:90px;">時刻</th><th>種目名</th><th style="width:50px;">組</th>
                    <th style="width:70px;">距離m</th><th style="width:70px;">Start(m)</th>
                    <th style="width:50px;">人数</th><th>ペーサー設定</th><th style="width:60px;"></th>
                </tr>
            </thead>
            <tbody id="setup-tbody"></tbody>
        </table>
        <button class="btn-add-new" onclick="addNewRow()">＋ 新しいレースを作成</button>
    </div>

    <div id="screen-race" class="screen active">
        <div id="race-screen-title" style="font-size:24px; font-weight:bold; margin-bottom:20px; padding-left:10px; border-left:6px solid var(--primary-color); color:var(--text-main);"></div>
        <div style="margin-bottom:10px; color:#8E8E93; font-size:13px; text-align:right;">行をタップして詳細を展開</div>
        <table class="data-table">
            <tbody id="race-tbody"></tbody>
        </table>
    </div>

    <div id="screen-devices" class="screen">
        <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; font-size:24px; color:var(--primary-color);">デバイス設置</h2>
            <div style="text-align:right;">
                <div id="device-sync-status" class="status-badge status-clean" style="font-size:12px; margin-bottom:4px;">✓ 同期完了</div>
                <div style="font-size:11px; color:#888;">設置数: <span id="device-count-display">0 / 0</span></div>
            </div>
        </div>

        <div class="device-settings-panel">
            <div class="setting-group">
                <label class="setting-label">総距離 (m)</label>
                <input type="number" id="setting-distance" class="setting-input" value="400" step="100" onchange="updateRaceSettings(this.value, null)">
            </div>
            <div class="setting-group">
                <label class="setting-label">間隔 (m)</label>
                <select id="setting-interval" class="setting-select" onchange="updateRaceSettings(null, this.value)">
                    <option value="1">1m</option>
                    <option value="2" selected>2m</option>
                    <option value="4">4m</option>
                    <option value="5">5m</option>
                </select>
            </div>
            <div style="flex:1; display:flex; justify-content:flex-end; gap:10px; padding-bottom:5px;">
                <button class="btn-sm btn-outline" onclick="fillWithDummy()">＋ 残りをダミーで埋める</button>
                <button class="btn-sm btn-outline" onclick="downloadCSV()">⬇ CSV出力</button>
                <button class="btn-sm btn-outline" onclick="document.getElementById('csv-input').click()">⬆ CSV取込</button>
                <input type="file" id="csv-input" style="display:none" onchange="importCSV(this)" accept=".csv">
                <button class="btn-sm btn-danger" onclick="clearDeviceList()">🗑 全削除</button>
                <button class="btn-sm btn-primary" onclick="syncAllDevices()">🔄 同期</button>
            </div>
        </div>

        <div style="margin-bottom:10px; background:#FFF3CD; padding:10px; border-radius:8px; font-size:13px; color:#856404;">
            ※ <strong>登録方法:</strong> Glow-R本体のボタンを押すと自動追加されます。<br>
            ※ <strong>操作:</strong> マスをクリックすると「テスト点灯」「ダミー化」「交換」メニューが開きます。
        </div>
        
        <div id="device-list-container">
            <!-- Grid Rendered by JS -->
        </div>
    </div>
</main>

<div id="modal-settings" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">ペーサー設定</h3>
        <div class="color-selector">
            <div class="color-option bg-red" onclick="selectModalColor('red')"></div>
            <div class="color-option bg-blue" onclick="selectModalColor('blue')"></div>
            <div class="color-option bg-green" onclick="selectModalColor('green')"></div>
            <div class="color-option bg-yellow" onclick="selectModalColor('yellow')"></div>
            <div class="color-option bg-purple" onclick="selectModalColor('purple')"></div>
            <div class="color-option bg-white" onclick="selectModalColor('white')"></div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; margin:30px 0;">
            <input type="number" id="modal-pace-input" step="0.1" value="72.0" style="font-size:32px; width:120px; text-align:right; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <span style="font-size:16px; font-weight:bold; color:#888;">秒 / 400m</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-sm btn-danger" style="border:none; background:#FFF0F0;" onclick="deletePacerFromModal()">削除</button>
            <div style="display:flex; gap:10px;">
                <button class="btn-sm btn-outline" style="border:none; background:#F2F2F7; color:#555;" onclick="closeModal()">キャンセル</button>
                <button class="btn-sm btn-primary" style="padding:10px 24px; font-size:14px;" onclick="saveModalData()">設定を保存</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-version" class="modal-overlay" onclick="if(event.target===this) closeVersionModal()">
    <div class="modal-content" style="text-align:center; width:300px;">
        <img src="image_c2633c.png" style="width:60px; margin-bottom:10px;">
        <h3>Glow-Rabbit Web</h3>
        <p style="color:#888; font-family:monospace;">Version: 2.0.0-alpha</p>
        <p style="color:#CCC; font-size:12px;">Refactored: Modular Architecture</p>
        <button class="btn-sm btn-primary" onclick="closeVersionModal()">閉じる</button>
    </div>
</div>

<script type="module" src="main.js"></script>
</body>
</html>