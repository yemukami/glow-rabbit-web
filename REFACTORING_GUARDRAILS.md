# Glow-Rabbit Web App - Refactoring Guardrails

目的: 「各処理の目的を常に明確化し、破綻のないリファクタリング」を実現するための作業ルール。変更作業中は必ずこのガイドを参照し、逸脱しそうな場合は修正方針を見直す。

## 1. 目的ドリブン
- 変更前に「この処理/関数/変更の目的」を1行で明示し、コメントやコミットメモに反映する。
- 目的に沿わない副作用・責務混在を避ける。1つの変更で複数目的を抱えない。

## 2. 副作用とデータフローの透明化
- DOM操作・localStorage書き込み・BLE送信などの副作用は呼び出しレイヤーで集約し、純粋関数と分離する。
- データの「真実の源」を明示し、読み取り専用か更新可能かを関数シグネチャで示す（引数/戻り値/オプション）。
- グローバル状態に書き込む場合は「誰が更新するか」を限定し、状態ハンドラに集中させる。

## 3. 事前・事後チェック（TDD/静的検証）
- 変更対象JSは必ず `node --check <file>` で構文検査。
- ロジック変更はNodeテストを優先して追加/実行（`js/test/` 配下）。UI抽出関数は純粋化しテスト可能にする。
- BLE送信は `sendCommand` キュー経由のみ、高優先度コマンドはキュークリアを意図して指定。

## 4. 安全なレンダリングと入力処理
- ユーザー入力をDOMに流すときはサニタイズ/エスケープを必須とし、HTML文字列生成はテンプレート関数化。
- ガード節を徹底し、空配列/未定義/0除算/NaNを許容しない。

## 5. 小さく進めて常に動作可能に
- 長大関数は最小限の分割単位で段階的にリファクタリングし、毎ステップで動作確認を挟む。
- マジックナンバーは定数化し、意味づけをコメントや命名で明確化。

## 6. 失敗の見える化
- 例外は握りつぶさず呼び出し元に伝播させ、UI/ログで検知可能にする。
- レビュー用JSONや検証スクリプト（`run_review.sh` / `spec_verify.sh` / `make test.min`）の実行結果を記録し、未実行なら理由を残す。

## 7. 依存方向の整理
- 依存は UI → Core → BLE の一方向を維持し、循環参照を作らない。
- 新規APIを追加する際はインターフェース層（Core）で抽象化し、BLE具体実装を下位に閉じ込める。

## 運用
- 作業開始時にこのファイルを再確認し、変更方針を目的ごとにメモ。完了時に目的と結果が一致しているか自己チェックする。
